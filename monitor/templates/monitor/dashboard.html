{% load static %}
{% load custom_tags %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Temperature and Humidity Control</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-100 p-6">
  <div class="max-w-7xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4 text-center">Temperature and Humidity Control</h1>

      <div class="text-center mt-4 m-4">
        <a id="generate-pdf-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          üìä Generate Daily Chart (PDF)
        </a>
        <a href="{% url 'range_chart' %}" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 p-4">
          <button>
            View Range Chart
          </button>
        </a>
      </div>

    <script>
      document.getElementById("generate-pdf-btn").addEventListener("click", function () {
        const date = document.querySelector('input[name="date"]').value;
        const container = document.querySelector('input[name="container"]').value;
        const pallet = document.querySelector('input[name="pallet"]').value;
        const product = document.querySelector('input[name="product"]').value;

        const url = new URL("/generate-chart-pdf/", window.location.origin);
        url.searchParams.append("date", date);
        url.searchParams.append("container", container);
        url.searchParams.append("pallet", pallet);
        url.searchParams.append("product", product);

        window.open(url.toString(), "_blank");
      });
    </script>

      <!-- Filter Form -->
      <form method="get" class="bg-white shadow-md rounded-lg p-4 mb-6 flex flex-wrap gap-4">
        <!-- Date filter -->
        <div>
          <label class="block font-semibold">Date:</label>
          <input type="date" name="date" value="{{ date }}" class="border rounded px-3 py-1">
        </div>

        <!-- Hour filters -->
        <div>
          <label class="block font-semibold">Start Hour:</label>
          <select name="start_hour" class="border rounded px-3 py-1">
            {% for h in 0|to:23 %}
            <option value="{{ h }}" {% if request.GET.start_hour == h|stringformat:"s" %}selected{% endif %}>
                {{ h }}:00
            </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="block font-semibold">End Hour:</label>
          <select name="end_hour" class="border rounded px-3 py-1">
            {% for h in 0|to:23 %}
            <option value="{{ h }}" {% if request.GET.end_hour == h|stringformat:"s" %}selected{% endif %}>
                {{ h }}:00
            </option>
            {% endfor %}
          </select>
        </div>

        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 mt-6">
          Apply Filter
        </button>
      </form>

      <!-- Temperature Chart -->
      <div class="bg-white rounded shadow p-4">
        <canvas id="temperatureChart" class="w-full h-96"></canvas>
      </div>

      {% if temp_alerts %}
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
        <h2 class="font-bold text-lg mb-2">‚ö†Ô∏è WASPADA: Suhu mendekati ambang batas!</h2>
        <ul class="list-disc ml-5">
          {% for a in temp_alerts %}
            <li>
              <strong>{{ a.timestamp|date:"H:i" }}</strong> ‚Äì Temperature: {{ a.temperature }}¬∞C
            </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

    <!-- Humidity Chart -->
      <div class="bg-white rounded shadow p-4">
        <canvas id="humidityChart" class="w-full h-96"></canvas>
      </div>

      {% if humidity_alerts %}
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
        <h2 class="font-bold text-lg mb-2">‚ö†Ô∏è WASPADA: Kelembapan mendekati ambang batas!</h2>
        <ul class="list-disc ml-5">
          {% for a in humidity_alerts %}
            <li>
              <strong>{{ a.timestamp|date:"H:i" }}</strong> ‚Äì Humidity: {{ a.humidity }}%
            </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- Temperature & Humidity Chart.js -->
      <script>
        Chart.register(window['chartjs-plugin-annotation']);

        // Arrays
        const labels = {{ labels|default:"[]"|safe }};
        const temps = {{ temps|default:"[]"|safe }};
        const ewmaTemps = {{ ewma_temps|default:"[]"|safe }};
        const hums = {{ hums|default:"[]"|safe }};
        const ewmaHums = {{ ewma_hums|default:"[]"|safe }};

        // Forecast arrays
        const forecastLabels = {{ forecast_labels|default:"[]"|safe }};
        const tempForecast = {{ temp_forecast|default:"[]"|safe }};
        const humForecast = {{ hum_forecast|default:"[]"|safe }};

        // Control Limits
        const clTemp = {{ cl_temp|default:"null"|safe }};
        const uclTemp = {{ ucl_temp|default:"null"|safe }};
        const lclTemp = {{ lcl_temp|default:"null"|safe }};
        const clHum = {{ cl_hum|default:"null"|safe }};
        const uclHum = {{ ucl_hum|default:"null"|safe }};
        const lclHum = {{ lcl_hum|default:"null"|safe }};

        // Merge forecast labels into main labels
        const chartLabels = labels.concat(forecastLabels);

        const tempsCtx = document.getElementById('temperatureChart').getContext('2d');
        const tempsChart = new Chart(tempsCtx, {
          type: 'bar',
          data: {
            labels: chartLabels,
            datasets: [
                    {
                      type: 'line',
                      label: 'Temperature (¬∞C)',
                      data: temps,
                      borderColor: 'green',
                      backgroundColor: 'green',
                      yAxisID: 'y',
                      tension: 0.3,
                      fill: false,
                      pointBackgroundColor: temps.map(value => {
                        if (value > -15) return 'red';        // Above -15¬∞C
                        if (value > -18) return 'orange';     // Between -18¬∞C and -15¬∞C
                        return 'green';                       // Safe zone
                      }),
                      pointRadius: 5,
                      pointRadius: temps.map(value => {
                        if (value > -15) return 9;
                        if (value > -18) return 7;
                        return 5;
                      })
                    },
                    {
                      type: 'line',
                      label: 'EWMA Temperature (¬∞C)',
                      data: ewmaTemps,
                      borderColor: 'blue',
                      backgroundColor: 'transparent',
                      borderWidth: 2,
                      yAxisID: 'y',
                      tension: 0.3,
                      pointRadius: 0 // smooth line without points
                    },
                    {
                      type: 'line',
                      label: 'Forecast Temp (¬∞C)',
                      data: labels.map(() => null).concat(tempForecast),
                      borderColor: 'orange',
                      borderDash: [3, 3],
                      tension: 0.3,
                      fill: false,
                    }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                position: 'left',
                beginAtZero: false,
                min: -21,
                max: -13,
                title: { display: true, text: 'Temperature (¬∞C)' }
              }
            },
            plugins: {
              annotation: {
                annotations: {
                  lowTemp: {
                      type: 'line',
                      yMin: -18,
                      yMax: -18,
                      borderColor: 'orange',
                      borderWidth: 2,
                      borderDash: [5, 5],
                      label: {
                        display: true,
                        content: 'Batas Aman -18¬∞C',
                        position: 'start',
                        backgroundColor: 'orange'
                      }
                  },
                  highTemp: {
                    type: 'line',
                    yMin: -15,
                    yMax: -15,
                    borderColor: 'red',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    label: {
                      display: true,
                      content: 'Batas Bahaya -15¬∞C',
                      position: 'start',
                      backgroundColor: 'red'
                    }
                  },
                  clLine: {
                    type: 'line',
                    yMin: clTemp,
                    yMax: clTemp,
                    borderColor: 'blue',
                    borderWidth: 3,
                    borderDash: [6, 6],
                    label: {
                      display: true,
                      content: [`CL ${clTemp}¬∞C`],
                      position: 'end', // 'start', 'center', or 'end'
                      backgroundColor: 'rgb(0,0,255)',
                      color: 'white',
                      font: {
                        size: 12,
                        style: 'bold'
                      },
                      rotation: 0 // keep text horizontal
                    }
                  },
                  uclLine: {
                    type: 'line',
                    yMin: uclTemp,
                    yMax: uclTemp,
                    borderColor: 'green',
                    borderWidth: 3,
                    borderDash: [6, 6],
                    label: {
                      display: true,
                      content: [`UCL ${uclTemp}¬∞C`],
                      position: 'end', // 'start', 'center', or 'end'
                      backgroundColor: 'rgb(0,128,0)',
                      color: 'white',
                      font: {
                        size: 12,
                        style: 'bold'
                      },
                      rotation: 0 // keep text horizontal
                    }
                  },
                  lclLine: {
                    type: 'line',
                    yMin: lclTemp,
                    yMax: lclTemp,
                    borderColor: 'green',
                    borderWidth: 3,
                    borderDash: [6, 6],
                    label: {
                      display: true,
                      content: [`LCL ${lclTemp}¬∞C`],
                      position: 'end', // 'start', 'center', or 'end'
                      backgroundColor: 'rgb(0,128,0)', 
                      color: 'white',
                      font: {
                        size: 12,
                        style: 'bold'
                      },
                      rotation: 0 // keep text horizontal
                    }
                  }
                }
              },
              legend: { position: 'top' },
              title: {
                display: true,
                text: 'Temperature Chart (EWMA + Control Limits)',
                font: { size: 16 }
              }
            }
          }
        });

        const humsCtx = document.getElementById('humidityChart').getContext('2d');
        const humsChart = new Chart(humsCtx, {
          type: 'bar',
          data: {
            labels: chartLabels,
            datasets: [
                    {
                      type: 'line',
                      label: 'Humidity (%)',
                      data: hums,
                      borderColor: 'blue',
                      backgroundColor: 'blue',
                      yAxisID: 'y',
                      tension: 0.3,
                      fill: false,
                      pointBackgroundColor: hums.map(value => {
                        if (value > 88) return 'red';        // Above -15¬∞C
                        if (value > 85) return 'orange';     // Between -18¬∞C and -15¬∞C
                        return 'blue';                       // Safe zone
                      }),
                      pointRadius: 5,
                      pointRadius: hums.map(value => {
                        if (value > 88) return 9;
                        if (value > 85) return 7;
                        return 5;
                      })
                    },
                    {
                      type: 'line',
                      label: 'EWMA Humidity (%)',
                      data: ewmaHums,
                      borderColor: 'purple',
                      backgroundColor: 'transparent',
                      borderWidth: 2,
                      tension: 0.3,
                      pointRadius: 0
                    },
                    {
                      type: 'line',
                      label: 'Forecast Humidity (%)',
                      data: labels.map(() => null).concat(humForecast),
                      borderColor: 'orange',
                      borderDash: [3, 3],
                      tension: 0.3,
                      fill: false,
                    }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                position: 'left',
                beginAtZero: false,
                min: 55,
                max: 90,
                title: { display: true, text: 'Humidity (%)' }
              }
              },
            plugins: {
              annotation: {
                annotations: {
                  lowHum: {
                    type: 'line',
                    yMin: 85,
                    yMax: 85,
                    borderColor: 'orange',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    label: {
                      display: true,
                      content: 'Batas Aman 85 %',
                      position: 'start',
                      backgroundColor: 'orange'
                    }
                  },
                  highHum: {
                    type: 'line',
                    yMin: 88,
                    yMax: 88,
                    borderColor: 'red',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    label: {
                      display: true,
                      content: 'Batas Bahaya 88 %',
                      position: 'start',
                      backgroundColor: 'red'
                    }
                  },
                  clLine: {
                    type: 'line',
                    yMin: clHum,
                    yMax: clHum,
                    borderColor: 'purple',
                    borderWidth: 3,
                    borderDash: [6, 6],
                    label: {
                      display: true,
                      content: [`CL ${clHum}¬∞C`],
                      position: 'end', // 'start', 'center', or 'end'
                      backgroundColor: 'rgb(128, 0, 255)',
                      color: 'white',
                      font: {
                        size: 12,
                        style: 'bold'
                      },
                      rotation: 0 // keep text horizontal
                    }
                  },
                  uclLine: {
                    type: 'line',
                    yMin: uclHum,
                    yMax: uclHum,
                    borderColor: 'green',
                    borderWidth: 3,
                    borderDash: [6, 6],
                    label: {
                      display: true,
                      content: [`UCL ${uclHum}¬∞C`],
                      position: 'end', // 'start', 'center', or 'end'
                      backgroundColor: 'rgb(0,128,0)',
                      color: 'white',
                      font: {
                        size: 12,
                        style: 'bold'
                      },
                      rotation: 0 // keep text horizontal
                    }
                  },
                  lclLine: {
                    type: 'line',
                    yMin: lclHum,
                    yMax: lclHum,
                    borderColor: 'green',
                    borderWidth: 3,
                    borderDash: [6, 6],
                    label: {
                      display: true,
                      content: [`LCL ${lclHum}¬∞C`],
                      position: 'end', // 'start', 'center', or 'end'
                      backgroundColor: 'rgb(0,128,0)',
                      color: 'white',
                      font: {
                        size: 12,
                        style: 'bold'
                      },
                      rotation: 0 // keep text horizontal
                    }
                  }
                }
              },
              legend: { position: 'top' },
              title: {
                display: true,
                text: 'Humidity Chart (EWMA + Control Limits)',
                font: { size: 16 }
              }
            }
          }
        });
      </script>

      <div class="bg-gray-100 p-4 mb-6 rounded shadow">
        <div><strong>Date:</strong> {{ date }}</div>
        <div><strong>Container Code:</strong> {{ metadata.container_code }}</div>
        <div><strong>Pallet Position:</strong> {{ metadata.pallet_position }}</div>
        <div><strong>Product:</strong> {{ metadata.product_description }}</div>
      </div>
    </div>

  </div>

</body>
</html>
